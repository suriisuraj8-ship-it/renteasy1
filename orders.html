<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders | Chat Point</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --bg1: #071021;
      --bg2: #0b2236;
      --card: rgba(255,255,255,0.04);
      --text: #eaf0f2;
      --muted: #b8a78f;
      --accent-fresh: #2ecf7b;
      --accent-warm: #ff8a3d;
      --radius: 18px;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:'Outfit',sans-serif;
      background:linear-gradient(135deg,#0a0f2c 0%,#0f1a38 100%);
      color:var(--text);
      min-height:100vh;
      padding:20px;
    }
    .container{max-width:700px;margin:auto;}
    h1{text-align:center;margin-bottom:24px;color:var(--accent-fresh);font-weight:700;}

    .login-prompt{text-align:center;padding:60px 20px;color:#aaa;font-size:18px;}
    .login-prompt a{color:var(--accent-warm);text-decoration:none;font-weight:600;}

    .order-card{
      background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:16px;
      border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(10px);
      transition:transform .2s ease;
    }
    .order-card:hover{transform:translateY(-2px);}
    .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;font-weight:600;}
    .order-id{color:var(--accent-fresh);font-size:14px;}
    .order-date{font-size:13px;color:var(--muted);}
    .status{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;}
    .status.pending{background:#ffeb3b33;color:#ffc107;}
    .status.delivered{background:#4caf5033;color:#4caf50;}
    .status.cancelled{background:#f4433633;color:#f44336;}

    .items-list{margin:12px 0;padding-left:8px;border-left:2px solid var(--accent-warm);}
    .item-line{display:flex;justify-content:space-between;font-size:14px;padding:4px 0;}
    .total-line{display:flex;justify-content:space-between;font-weight:700;margin-top:10px;
                padding-top:10px;border-top:1px dashed rgba(255,255,255,.2);}

    .address{margin-top:12px;font-size:14px;color:var(--muted);}

    .empty-state{text-align:center;padding:60px 20px;color:var(--muted);font-size:18px;}
    .empty-state i{font-size:48px;margin-bottom:16px;color:#555;}
    .back-btn{
      display:block;width:100%;max-width:300px;margin:30px auto 0;
      padding:12px;background:linear-gradient(90deg,var(--accent-fresh),var(--accent-warm));
      color:#000;font-weight:700;text-align:center;border-radius:14px;
      text-decoration:none;font-size:16px;
    }
    .loading{text-align:center;color:#aaa;padding:20px;}
    .error-box{background:#7f1d1d33;color:#fca5a5;padding:16px;border-radius:12px;margin:16px 0;font-size:14px;}
  </style>
</head>
<body>

<div class="container">
  <h1>My Orders</h1>
  <div id="ordersContainer"></div>
</div>

<script>
  /* ==================== CONFIG ==================== */
  const USER_KEY   = 'chatpoint_user';
  const CACHE_KEY  = 'my-orders-cache';
  const POLL_MS    = 30_000;

  // FIXED: Use window.location.origin (Render-safe)
  const API_BASE = window.location.origin;

  const $ = s => document.querySelector(s);

  /* ==================== HELPERS ==================== */
  const getUser = () => {
    try { return JSON.parse(localStorage.getItem(USER_KEY)); }
    catch { return null; }
  };

  const formatDate = d => new Date(d).toLocaleDateString('en-IN', {
    day:'2-digit', month:'short', year:'numeric',
    hour:'2-digit', minute:'2-digit'
  });

  const cache = {
    get: () => { try { return JSON.parse(localStorage.getItem(CACHE_KEY)); } catch { return null; } },
    set: data => { try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } catch {} }
  };

  /* ==================== RENDER ORDER ==================== */
  const renderOrder = order => {
    const itemsHtml = order.items.map(i => `
      <div class="item-line">
        <span>${i.name} × ${i.quantity}</span>
        <span>₹${(i.price * i.quantity).toFixed(2)}</span>
      </div>`).join('');

    const status = order.status.toLowerCase();
    const delivery = order.deliveryCharge ?? 30;
    const grand = (order.totalAmount + delivery).toFixed(2);

    return `
      <div class="order-card">
        <div class="order-header">
          <div class="order-id">Order #${order._id.slice(-6)}</div>
          <div class="order-date">${formatDate(order.date)}</div>
        </div>
        <div class="status ${status}">${order.status.toUpperCase()}</div>
        <div class="items-list">${itemsHtml}</div>
        <div class="total-line">
          <span>Grand Total</span>
          <span style="color:var(--accent-fresh)">₹${grand}</span>
        </div>
        <div class="address">
          <strong>Delivery:</strong> ${order.address.name}, ${order.address.phone}<br>
          ${order.address.line1}${order.address.line2 ? ', ' + order.address.line2 : ''}
        </div>
      </div>`;
  };

  /* ==================== FETCH ORDERS ==================== */
  const fetchOrders = async (useCache = true) => {
    const container = $('#ordersContainer');
    const user = getUser();

    if (!user?._id) {
      container.innerHTML = `
        <div class="login-prompt">
          <h3>Please log in to view your orders</h3>
          <p><a href="/login.html">Go to Login</a></p>
        </div>`;
      return;
    }

    if (useCache) {
      const cached = cache.get();
      if (cached?.orders?.length) {
        container.innerHTML = cached.orders.map(renderOrder).join('');
      } else {
        container.innerHTML = `<p class="loading"><i class="fas fa-spinner fa-spin"></i> Loading orders…</p>`;
      }
    }

    try {
      const res = await fetch(`${API_BASE}/api/my-orders`, {
        headers: { 'x-user-id': user._id }
      });

      const text = await res.text();

      if (text.trim().startsWith('<!') || text.includes('<html')) {
        throw new Error(`Server returned HTML. Check backend at ${API_BASE}/api/my-orders`);
      }

      let data;
      try { data = JSON.parse(text); }
      catch (e) { throw new Error(`Invalid JSON: ${e.message}`); }

      if (!data.success || !Array.isArray(data.orders) || data.orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <p>No orders yet.</p>
            <a href="/index.html" class="back-btn">Shop Now</a>
          </div>`;
        cache.set(data);
        return;
      }

      container.innerHTML = data.orders.map(renderOrder).join('');
      cache.set(data);

    } catch (err) {
      console.error('Fetch error:', err);
      container.innerHTML = `
        <div class="error-box">
          <strong>Failed to load orders</strong><br><br>
          ${err.message}
          <br><br>
          <a href="/orders.html" style="color:var(--accent-warm);text-decoration:underline;">Retry</a>
        </div>`;
    }
  };

  /* ==================== POLLING ==================== */
  let pollTimer;
  const startPolling = () => {
    clearInterval(pollTimer);
    pollTimer = setInterval(() => {
      if (getUser()?._id) fetchOrders(false);
    }, POLL_MS);
  };

  /* ==================== START ==================== */
  document.addEventListener('DOMContentLoaded', () => {
    fetchOrders(true);
    startPolling();
  });
</script>

</body>
</html>